<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Kitablar - Booksy</title>
    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar Toggle Button (Fixed Left) - Only visible when sidebar is closed -->
    <div class="sidebar-toggle-container" id="sidebarToggleContainer">
        <button class="sidebar-toggle-fixed" id="sidebarToggleFixed">
            <i class="fas fa-bars" id="toggleIconFixed"></i>
        </button>
        <a href="index.html" class="sidebar-fixed-icon" id="homeIcon" title="Ana Səhifə">
            <i class="fas fa-home"></i>
        </a>
        <a href="blog.html" class="sidebar-fixed-icon" title="Blog">
            <i class="fas fa-blog"></i>
        </a>
        <a href="audiobooks.html" class="sidebar-fixed-icon" id="audiobooksIcon" title="Sesli Kitablar" style="display: none;">
            <i class="fas fa-headphones"></i>
        </a>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="index.html" style="color: #5c977c; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-book"></i>
                    <span>Booksy</span>
                </a>
            </div>
            
            <div class="nav-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Axtar...">
                </div>
            </div>
            
            <div class="nav-links">
                <div id="userProfile">
                    <div class="user-profile" id="userProfileTrigger">
                        <img id="userAvatar" src="" alt="User" class="user-avatar" style="display: none;">
                        <span id="userName" class="user-name"></span>
                        <!-- <i class="fas fa-chevron-down user-dropdown-icon"></i> -->
                    </div>
                    <div class="user-dropdown-menu" id="userDropdownMenu" style="display: none;">
                        <a href="#" class="dropdown-item" onclick="showProfile(); return false;">
                            <i class="fas fa-user"></i>
                            <span>Profil</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout(); return false;">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Çıxış</span>
                        </a>
                    </div>
                </div>
                <div id="loginSection">
                    <button class="google-login-btn" id="loginBtn">
                        <span>Google</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Header -->
            <header class="page-header">
                <h1>Kitabın səsi</h1>
                <p id="rotatingText">“Kitablar cibində, səslər qulağında.”</p>
            </header>

            <!-- Content Layout -->
            <div class="content-layout">
                <!-- Sidebar -->
                <aside class="sidebar" id="sidebar">
                    <button class="sidebar-toggle-inside" id="sidebarToggleInside">
                        <i class="fas fa-bars" id="toggleIconInside"></i>
                    </button>
                    <div class="sidebar-content" id="sidebarContent">
                        <h3>İzləmə</h3>
                        
                        <div class="sidebar-stats" style="margin-top: 30px;">
                            <div class="stat-item">
                                <span>Ümumi:</span>
                                <span id="totalAudiobooks">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Göstərilən:</span>
                                <span id="displayedAudiobooks">0</span>
                            </div>
                        </div>

                        <div class="items-per-page" style="margin-top: 20px;">
                            <label for="audiobooksPerPage">Səhifə başına:</label>
                            <select id="audiobooksPerPage">
                                <option value="10">10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">Hamısı</option>
                            </select>
                        </div>

                        <div class="category-filter" style="margin-top: 20px;">
                            <label for="audiobookCategoryFilter">Kategoriya:</label>
                            <select id="audiobookCategoryFilter">
                                <option value="all">Tüm Kategoriler</option>
                            </select>
                        </div>
                        
                        <div class="sidebar-blog-link" style="margin-top: 30px;">
                            <a href="index.html" class="blog-btn">
                                <i class="fas fa-home"></i>
                                <span>Ana Səhifə</span>
                            </a>
                        </div>
                        <div class="sidebar-blog-link">
                            <a href="blog.html" class="blog-btn">
                                <i class="fas fa-blog"></i>
                                <span>Blog</span>
                            </a>
                        </div>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <div class="main-area">
                    <!-- Audiobooks Grid -->
                    <div class="audiobooks-grid" id="audiobooksGrid">
                        <!-- Audiobooks will be loaded here -->
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="audiobooksPagination" style="display: none;">
                        <button class="pagination-btn" id="prevBtn" onclick="goToAudiobookPage(currentAudiobookPage - 1)">‹ Əvvəlki</button>
                        <div class="pagination-numbers" id="audiobookPageNumbers"></div>
                        <button class="pagination-btn" id="nextBtn" onclick="goToAudiobookPage(currentAudiobookPage + 1)">Növbəti ›</button>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="loading" id="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Sesli kitablar yüklənir...</p>
                    </div>

                    <!-- No Results -->
                    <div class="no-results" id="noResults" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>Hələ heç bir sesli kitab yoxdur</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio Player (Fixed Bottom Right) -->
    <div id="audioPlayer" class="audio-player" style="display: none;">
        <div class="audio-player-content">
            <div class="audio-info">
                <div class="audio-title" id="playerTitle">Sesli Kitab</div>
                <div class="audio-author-row">
                    <div class="audio-author" id="playerAuthor"></div>
                    <div class="audio-volume-control-inline">
                        <button id="volumeBtn" class="audio-volume-btn" onclick="toggleMute()">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div class="audio-volume-slider" id="volumeSlider">
                            <div class="audio-volume-bar" id="volumeBar"></div>
                            <div class="audio-volume-thumb" id="volumeThumb"></div>
                        </div>
                    </div>
                </div>
            </div>
            <audio id="audioElement" class="audio-element-hidden">
                <source src="" type="audio/mpeg">
                Sizin brauzer audio elementini dəstəkləmir.
            </audio>
            <div class="custom-audio-controls">
                <button id="playPauseBtn" class="audio-control-btn" onclick="togglePlayPause()">
                    <i class="fas fa-play"></i>
                </button>
                <div class="audio-progress-container" onclick="seekAudio(event)">
                    <div id="progressBar" class="audio-progress-bar"></div>
                </div>
                <div class="audio-time-display" id="timeDisplay">0:00 / 0:00</div>
            </div>
            <button class="audio-close-btn" onclick="closeAudioPlayer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <style>
        .audio-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            z-index: 1000;
            min-width: 300px;
            max-width: 500px;
        }

        .audio-player-content {
            position: relative;
        }

        .audio-info {
            margin-bottom: 15px;
        }

        .audio-title {
            font-weight: 600;
            color: #5c977c;
            margin-bottom: 5px;
        }

        .audio-author-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .audio-author {
            font-size: 0.9rem;
            color: #666;
            flex: 1;
        }

        .audio-volume-control-inline {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .audio-close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #f44336;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .audio-close-btn:hover {
            background: #d32f2f;
        }

        /* Custom Audio Controls */
        .custom-audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .audio-control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #5c977c;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .audio-control-btn:hover {
            background: #5c977c;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(92, 151, 124, 0.5);
        }

        .audio-control-btn.pause-btn {
            background: #f44336;
        }

        .audio-control-btn.pause-btn:hover {
            background: #d32f2f;
        }

        .audio-progress-container {
            flex: 1;
            position: relative;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            cursor: pointer;
        }

        .audio-progress-bar {
            height: 100%;
            background: #5c977c;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .audio-time-display {
            font-size: 0.85rem;
            color: #5c977c;
            min-width: 80px;
            text-align: right;
        }

        .audio-element-hidden {
            display: none;
        }

        .audio-volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .audio-volume-control-inline {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .audio-volume-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #5c977c;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .audio-volume-btn:hover {
            background: #5c977c;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(92, 151, 124, 0.5);
        }

        .audio-volume-slider {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            min-width: 80px;
            max-width: 120px;
            width: 100px;
        }

        .audio-volume-bar {
            height: 100%;
            background: #5c977c;
            border-radius: 3px;
            width: 100%;
            position: relative;
        }

        .audio-volume-thumb {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #5c977c;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s ease;
        }

        .audio-volume-thumb:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .audio-volume-thumb:active {
            cursor: grabbing;
        }

        /* Audiobook Card Styles */
        .audiobook-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #e8f5e8;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .audiobook-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: #5c977c;
        }

        .audiobook-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .audiobook-image-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            flex-shrink: 0;
        }

        .audiobook-image-placeholder i {
            font-size: 32px;
        }

        .audiobook-info {
            flex: 1;
            min-width: 0;
        }

        .audiobook-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
            font-size: 1rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .audiobook-author {
            font-size: 0.9rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .audiobook-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #60997f;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .audiobook-play-btn:hover {
            background: #60997f;
            transform: scale(1.1);
        }

        .audiobooks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .audiobooks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Wrap in IIFE to avoid global scope conflicts
        (function() {
        let audiobooks = [];
        let filteredAudiobooks = [];
        let currentAudioId = null;
        let currentAudiobookPage = 1;
        let audiobooksItemsPerPage = 10; // Renamed to avoid conflict with script.js
        let selectedCategory = 'all';

        async function loadAudiobooks() {
            try {
                const response = await fetch('/api/audiobooks');
                const data = await response.json();
                
                const loading = document.getElementById('loading');
                const noResults = document.getElementById('noResults');
                const grid = document.getElementById('audiobooksGrid');
                
                loading.style.display = 'none';
                
                if (!data.audiobooks || data.audiobooks.length === 0) {
                    noResults.style.display = 'flex';
                    grid.innerHTML = '';
                    return;
                }
                
                noResults.style.display = 'none';
                audiobooks = data.audiobooks;
                
                populateAudiobookCategoryFilter();
                filterAudiobooks();
                updateAudiobookDisplay();
            } catch (error) {
                console.error('Error loading audiobooks:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noResults').style.display = 'flex';
            }
        }

        function playAudiobook(audiobookId) {
            const audiobook = audiobooks.find(a => a.id === audiobookId);
            if (!audiobook) return;

            currentAudioId = audiobookId;
            document.getElementById('playerTitle').textContent = audiobook.title;
            document.getElementById('playerAuthor').textContent = audiobook.author || '';
            
            const audioElement = document.getElementById('audioElement');
            
            // If different audiobook, load new one
            if (audioElement.src !== window.location.origin + audiobook.audioUrl) {
                audioElement.src = audiobook.audioUrl;
                audioElement.load();
            }
            
            // Save to localStorage
            const playerState = {
                audiobookId: audiobookId,
                title: audiobook.title,
                author: audiobook.author || '',
                audioUrl: audiobook.audioUrl,
                currentTime: audioElement.currentTime,
                isPlaying: !audioElement.paused
            };
            localStorage.setItem('audioPlayerState', JSON.stringify(playerState));
            
            // Show player
            const player = document.getElementById('audioPlayer');
            player.style.display = 'block';
            
            // Don't auto-play - user must click play button
            // Update button to show play icon
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (playPauseBtn && audioElement.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.classList.remove('pause-btn');
            }
            
            // Save current time periodically
            const timeUpdateHandler = function() {
                if (currentAudioId === audiobookId) {
                    playerState.currentTime = audioElement.currentTime;
                    playerState.isPlaying = !audioElement.paused;
                    localStorage.setItem('audioPlayerState', JSON.stringify(playerState));
                }
            };
            audioElement.addEventListener('timeupdate', timeUpdateHandler);
            
            // Update custom controls
            setupCustomControls();
        }

        function setupCustomControls() {
            const audioElement = document.getElementById('audioElement');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');

            // Update play/pause button
            function updatePlayPauseButton() {
                if (audioElement.paused) {
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playPauseBtn.classList.remove('pause-btn');
                } else {
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playPauseBtn.classList.add('pause-btn');
                }
            }

            // Update progress bar
            function updateProgress() {
                if (audioElement.duration) {
                    const progress = (audioElement.currentTime / audioElement.duration) * 100;
                    progressBar.style.width = progress + '%';
                    
                    // Update time display
                    const currentTime = formatTime(audioElement.currentTime);
                    const duration = formatTime(audioElement.duration);
                    timeDisplay.textContent = `${currentTime} / ${duration}`;
                }
            }

            // Format time
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Event listeners
            audioElement.addEventListener('play', function() {
                updatePlayPauseButton();
                // Save playing state
                const savedState = localStorage.getItem('audioPlayerState');
                if (savedState && currentAudioId) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.audiobookId === currentAudioId) {
                            state.isPlaying = true;
                            localStorage.setItem('audioPlayerState', JSON.stringify(state));
                        }
                    } catch (e) {}
                }
            });
            audioElement.addEventListener('pause', function() {
                updatePlayPauseButton();
                // Save paused state
                const savedState = localStorage.getItem('audioPlayerState');
                if (savedState && currentAudioId) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.audiobookId === currentAudioId) {
                            state.isPlaying = false;
                            localStorage.setItem('audioPlayerState', JSON.stringify(state));
                        }
                    } catch (e) {}
                }
            });
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('loadedmetadata', updateProgress);

            // Initial update
            updatePlayPauseButton();
            updateProgress();
            
            // Setup volume control
            setupVolumeControl();
        }

        function togglePlayPause() {
            const audioElement = document.getElementById('audioElement');
            if (audioElement.paused) {
                audioElement.play();
            } else {
                audioElement.pause();
            }
        }

        function seekAudio(event) {
            const audioElement = document.getElementById('audioElement');
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percent = x / rect.width;
            
            if (audioElement.duration) {
                audioElement.currentTime = percent * audioElement.duration;
            }
        }

        let currentVolume = 1;
        let isMuted = false;

        function setupVolumeControl() {
            const audioElement = document.getElementById('audioElement');
            const volumeBtn = document.getElementById('volumeBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeBar = document.getElementById('volumeBar');
            const volumeThumb = document.getElementById('volumeThumb');

            // Load saved volume
            const savedVolume = localStorage.getItem('audioVolume');
            if (savedVolume !== null) {
                currentVolume = parseFloat(savedVolume);
                audioElement.volume = currentVolume;
                updateVolumeUI();
            } else {
                audioElement.volume = 1;
            }

            // Volume slider click
            volumeSlider.addEventListener('click', function(e) {
                const rect = volumeSlider.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percent = Math.max(0, Math.min(1, x / rect.width));
                
                currentVolume = percent;
                audioElement.volume = currentVolume;
                isMuted = currentVolume === 0;
                localStorage.setItem('audioVolume', currentVolume);
                updateVolumeUI();
            });

            // Volume thumb drag
            let isDragging = false;
            volumeThumb.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const rect = volumeSlider.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const percent = Math.max(0, Math.min(1, x / rect.width));
                    
                    currentVolume = percent;
                    audioElement.volume = currentVolume;
                    isMuted = currentVolume === 0;
                    localStorage.setItem('audioVolume', currentVolume);
                    updateVolumeUI();
                }
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });

            function updateVolumeUI() {
                const volumePercent = currentVolume * 100;
                volumeBar.style.width = volumePercent + '%';
                // Thumb should be at the end of the volume bar
                volumeThumb.style.left = volumePercent + '%';
                volumeThumb.style.transform = 'translate(-50%, -50%)';

                if (isMuted || currentVolume === 0) {
                    volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                } else if (currentVolume < 0.5) {
                    volumeBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
                } else {
                    volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
            }

            window.updateVolumeUI = updateVolumeUI;
        }

        function toggleMute() {
            const audioElement = document.getElementById('audioElement');
            if (isMuted) {
                audioElement.volume = currentVolume || 0.5;
                isMuted = false;
            } else {
                audioElement.volume = 0;
                isMuted = true;
            }
            if (window.updateVolumeUI) {
                window.updateVolumeUI();
            }
        }

        function closeAudioPlayer() {
            const player = document.getElementById('audioPlayer');
            const audioElement = document.getElementById('audioElement');
            audioElement.pause();
            localStorage.removeItem('audioPlayerState');
            player.style.display = 'none';
            currentAudioId = null;
        }

        // Load player state on page load
        function loadPlayerState() {
            const savedState = localStorage.getItem('audioPlayerState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    const audioElement = document.getElementById('audioElement');
                    
                    document.getElementById('playerTitle').textContent = state.title;
                    document.getElementById('playerAuthor').textContent = state.author || '';
                    audioElement.src = state.audioUrl;
                    
                    audioElement.addEventListener('loadedmetadata', function() {
                        if (state.currentTime && state.currentTime > 0) {
                            audioElement.currentTime = state.currentTime;
                        }
                        // If it was playing before, resume playback
                        if (state.isPlaying) {
                            audioElement.play().catch(e => {
                                console.log('Auto-resume prevented:', e);
                            });
                        }
                    }, { once: true });
                    
                    audioElement.load();
                    
                    const player = document.getElementById('audioPlayer');
                    player.style.display = 'block';
                    currentAudioId = state.audiobookId;
                    
                    // Setup custom controls after loading
                    setTimeout(() => {
                        setupCustomControls();
                    }, 100);
                } catch (e) {
                    console.error('Error loading player state:', e);
                }
            }
        }

        // Save state before page unload to prevent interruption
        window.addEventListener('beforeunload', function() {
            const audioElement = document.getElementById('audioElement');
            if (audioElement && currentAudioId) {
                const playerState = {
                    audiobookId: currentAudioId,
                    title: document.getElementById('playerTitle')?.textContent || '',
                    author: document.getElementById('playerAuthor')?.textContent || '',
                    audioUrl: audioElement.src,
                    currentTime: audioElement.currentTime,
                    isPlaying: !audioElement.paused
                };
                localStorage.setItem('audioPlayerState', JSON.stringify(playerState));
            }
        });

        // Load audiobooks on page load
        loadAudiobooks();
        
        // Load player state on page load
        loadPlayerState();

        function getAudiobookCategoriesWithCounts() {
            const categories = {};
            audiobooks.forEach(audiobook => {
                if (audiobook.categories && Array.isArray(audiobook.categories)) {
                    audiobook.categories.forEach(cat => {
                        categories[cat] = (categories[cat] || 0) + 1;
                    });
                }
            });
            return categories;
        }

        function populateAudiobookCategoryFilter() {
            const categoryFilter = document.getElementById('audiobookCategoryFilter');
            const categories = getAudiobookCategoriesWithCounts();
            
            // Clear existing options except "all"
            categoryFilter.innerHTML = '<option value="all">Tüm Kategoriler</option>';
            
            // Sort categories by count
            const sortedCategories = Object.keys(categories).sort((a, b) => categories[b] - categories[a]);
            
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${categories[category]})`;
                categoryFilter.appendChild(option);
            });
        }

        function filterAudiobooks() {
            let filtered = [...audiobooks];
            
            // Apply category filter
            if (selectedCategory !== 'all') {
                filtered = filtered.filter(audiobook => 
                    audiobook.categories && audiobook.categories.includes(selectedCategory)
                );
            }
            
            filteredAudiobooks = filtered;
            currentAudiobookPage = 1; // Reset to first page
        }

        function updateAudiobookDisplay() {
            const grid = document.getElementById('audiobooksGrid');
            const pagination = document.getElementById('audiobooksPagination');
            
            // Calculate pagination
            const itemsPerPageNum = audiobooksItemsPerPage === 'all' ? filteredAudiobooks.length : parseInt(audiobooksItemsPerPage);
            const totalPages = Math.max(1, Math.ceil(filteredAudiobooks.length / itemsPerPageNum));
            const startIndex = (currentAudiobookPage - 1) * itemsPerPageNum;
            const endIndex = startIndex + itemsPerPageNum;
            const audiobooksToShow = filteredAudiobooks.slice(startIndex, endIndex);
            
            // Update stats
            document.getElementById('totalAudiobooks').textContent = audiobooks.length;
            document.getElementById('displayedAudiobooks').textContent = filteredAudiobooks.length;
            
            // Display audiobooks
            if (audiobooksToShow.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666; padding: 20px;">Sesli kitab tapılmadı</p>';
            } else {
                grid.innerHTML = audiobooksToShow.map(audiobook => {
                    const title = (audiobook.title || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const author = (audiobook.author || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const id = (audiobook.id || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    
                    return `
                        <div class="audiobook-card" onclick="playAudiobook('${id}')">
                            ${audiobook.imageUrl ? 
                                `<img src="${audiobook.imageUrl}" alt="${title}" class="audiobook-image">` : 
                                '<div class="audiobook-image-placeholder"><i class="fas fa-headphones"></i></div>'
                            }
                            <div class="audiobook-info">
                                <div class="audiobook-title">${title}</div>
                                <div class="audiobook-author">${author}</div>
                            </div>
                            <button class="audiobook-play-btn" onclick="event.stopPropagation(); playAudiobook('${id}')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // Update pagination
            if (totalPages > 1 && itemsPerPage !== 'all') {
                pagination.style.display = 'flex';
                updateAudiobookPaginationUI(totalPages);
            } else {
                pagination.style.display = 'none';
            }
        }

        function updateAudiobookPaginationUI(totalPages) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('audiobookPageNumbers');
            
            prevBtn.disabled = currentAudiobookPage === 1;
            nextBtn.disabled = currentAudiobookPage === totalPages;
            
            // Generate page numbers
            let pageHTML = '';
            const maxVisible = 5;
            let startPage = Math.max(1, currentAudiobookPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                pageHTML += `<span class="page-number ${currentAudiobookPage === 1 ? 'active' : ''}" onclick="goToAudiobookPage(1)">1</span>`;
                if (startPage > 2) {
                    pageHTML += '<span class="page-ellipsis">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageHTML += `<span class="page-number ${currentAudiobookPage === i ? 'active' : ''}" onclick="goToAudiobookPage(${i})">${i}</span>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageHTML += '<span class="page-ellipsis">...</span>';
                }
                pageHTML += `<span class="page-number ${currentAudiobookPage === totalPages ? 'active' : ''}" onclick="goToAudiobookPage(${totalPages})">${totalPages}</span>`;
            }
            
            pageNumbers.innerHTML = pageHTML;
        }

        function goToAudiobookPage(page) {
            const itemsPerPageNum = audiobooksItemsPerPage === 'all' ? filteredAudiobooks.length : parseInt(audiobooksItemsPerPage);
            const totalPages = Math.max(1, Math.ceil(filteredAudiobooks.length / itemsPerPageNum));
            
            if (page >= 1 && page <= totalPages) {
                currentAudiobookPage = page;
                updateAudiobookDisplay();
            }
        }

        // Event listeners
        document.getElementById('audiobooksPerPage').addEventListener('change', function(e) {
            audiobooksItemsPerPage = e.target.value;
            currentAudiobookPage = 1;
            updateAudiobookDisplay();
        });

        document.getElementById('audiobookCategoryFilter').addEventListener('change', function(e) {
            selectedCategory = e.target.value;
            filterAudiobooks();
            updateAudiobookDisplay();
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query === '') {
                filteredAudiobooks = [...audiobooks];
            } else {
                filteredAudiobooks = audiobooks.filter(audiobook => {
                    const title = (audiobook.title || '').toLowerCase();
                    const author = (audiobook.author || '').toLowerCase();
                    return title.includes(query) || author.includes(query);
                });
            }
            
            // Apply category filter
            if (selectedCategory !== 'all') {
                filteredAudiobooks = filteredAudiobooks.filter(audiobook => 
                    audiobook.categories && audiobook.categories.includes(selectedCategory)
                );
            }
            
            currentAudiobookPage = 1;
            updateAudiobookDisplay();
        });
        
        // Make functions globally available
        window.goToAudiobookPage = goToAudiobookPage;
        window.playAudiobook = playAudiobook;
        window.closeAudioPlayer = closeAudioPlayer;
        window.togglePlayPause = togglePlayPause;
        window.seekAudio = seekAudio;
        window.toggleMute = toggleMute;
        })(); // End IIFE
    </script>
    <script src="script.js"></script>
    <script>
        // Setup sidebar toggle for audiobooks page
        document.addEventListener('DOMContentLoaded', function() {
            // Call the main setupSidebarToggle function
            if (typeof setupSidebarToggle === 'function') {
                setupSidebarToggle();
            }
            const sidebarToggleFixed = document.getElementById('sidebarToggleFixed');
            const sidebarToggleInside = document.getElementById('sidebarToggleInside');
            const sidebar = document.getElementById('sidebar');
            const toggleIconFixed = document.getElementById('toggleIconFixed');
            const toggleIconInside = document.getElementById('toggleIconInside');
            const homeIcon = document.getElementById('homeIcon');
            const audiobooksIcon = document.getElementById('audiobooksIcon');
            
            // Open/Close sidebar function
            function toggleSidebar() {
                const isOpen = sidebar.classList.contains('open');
                
                if (isOpen) {
                    // Close
                    sidebar.classList.remove('open');
                    document.body.classList.remove('sidebar-container-open');
                    if (toggleIconFixed) {
                        toggleIconFixed.classList.remove('fa-times');
                        toggleIconFixed.classList.add('fa-bars');
                    }
                    if (toggleIconInside) {
                        toggleIconInside.classList.remove('fa-times');
                        toggleIconInside.classList.add('fa-bars');
                    }
                    // Show home icon, hide audiobooks icon when closed
                    if (homeIcon) homeIcon.style.display = 'flex';
                    if (audiobooksIcon) audiobooksIcon.style.display = 'none';
                } else {
                    // Open
                    sidebar.classList.add('open');
                    document.body.classList.add('sidebar-container-open');
                    if (toggleIconFixed) {
                        toggleIconFixed.classList.remove('fa-bars');
                        toggleIconFixed.classList.add('fa-times');
                    }
                    if (toggleIconInside) {
                        toggleIconInside.classList.remove('fa-bars');
                        toggleIconInside.classList.add('fa-times');
                    }
                    // Hide home icon, show audiobooks icon when open
                    if (homeIcon) homeIcon.style.display = 'none';
                    if (audiobooksIcon) audiobooksIcon.style.display = 'flex';
                }
            }
            
            // Open sidebar from fixed button
            if (sidebarToggleFixed) {
                sidebarToggleFixed.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSidebar();
                });
            }
            
            // Toggle sidebar from inside button
            if (sidebarToggleInside) {
                sidebarToggleInside.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSidebar();
                });
            }
            
            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    document.body.classList.remove('sidebar-container-open');
                    if (toggleIconFixed) {
                        toggleIconFixed.classList.remove('fa-times');
                        toggleIconFixed.classList.add('fa-bars');
                    }
                    if (toggleIconInside) {
                        toggleIconInside.classList.remove('fa-times');
                        toggleIconInside.classList.add('fa-bars');
                    }
                    // Show home icon, hide audiobooks icon when closed
                    if (homeIcon) homeIcon.style.display = 'flex';
                    if (audiobooksIcon) audiobooksIcon.style.display = 'none';
                }
            });
        });
    </script>
    <script>
        // Ensure loginWithGoogle is available and bind to button
        (function() {
            function setupLoginButton() {
                const loginBtn = document.getElementById('loginBtn') || document.querySelector('#loginSection .google-login-btn');
                if (loginBtn) {
                    // Remove any existing listeners by cloning
                    const newBtn = loginBtn.cloneNode(true);
                    loginBtn.parentNode.replaceChild(newBtn, loginBtn);
                    const btn = document.getElementById('loginBtn') || document.querySelector('#loginSection .google-login-btn');
                    
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Login button clicked');
                        
                        if (typeof window.loginWithGoogle === 'function') {
                            console.log('Calling window.loginWithGoogle');
                            window.loginWithGoogle();
                        } else {
                            console.error('loginWithGoogle function not found, using fallback');
                            // Fallback
                            fetch('/api/auth/google', {
                                credentials: 'include'
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Auth URL received:', data);
                                if (data.authUrl) {
                                    window.location.href = data.authUrl;
                                } else {
                                    alert('Giriş URL-i alına bilmədi');
                                }
                            })
                            .catch(error => {
                                console.error('Login error:', error);
                                alert('Giriş zamanı xəta baş verdi: ' + error.message);
                            });
                        }
                    });
                    console.log('Login button event listener added successfully');
                } else {
                    console.warn('Login button not found');
                }
            }
            
            // Try multiple times to ensure button is found
            let attempts = 0;
            function trySetup() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        setTimeout(setupLoginButton, 200);
                    });
                } else {
                    setTimeout(function() {
                        setupLoginButton();
                        attempts++;
                        const btn = document.getElementById('loginBtn') || document.querySelector('#loginSection .google-login-btn');
                        if (attempts < 10 && !btn) {
                            setTimeout(trySetup, 200);
                        }
                    }, 200);
                }
            }
            
            trySetup();
        })();
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 KitApp | Müəllif hüquqları qorunur.</p>
                <a href="https://t.me/your_channel" target="_blank" class="telegram-link-footer">
                    <i class="fab fa-telegram"></i>
                    Telegram
                </a>
            </div>
        </div>
    </footer>
</body>
</html>

